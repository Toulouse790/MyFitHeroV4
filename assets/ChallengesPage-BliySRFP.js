var D=t=>{throw TypeError(t)};var M=(t,e,r)=>e.has(t)||D("Cannot "+r);var n=(t,e,r)=>(M(t,e,"read from private field"),r?r.call(t):e.get(t)),v=(t,e,r)=>e.has(t)?D("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),C=(t,e,r,i)=>(M(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r),w=(t,e,r)=>(M(t,e,"access private method"),r);import{r as b,c as V,j as a}from"./index-CjnEZlsY.js";import{c as Y}from"./index-DYXWGdlE.js";import{S as H,s as W,h as J,n as q,a as B,b as ee,u as G}from"./useQuery-Be-wEKB7.js";import{u as K}from"./QueryClientProvider-ZBf36FVV.js";import{c as A}from"./clsx-B-dksMZM.js";import{t as _}from"./index-GGMoTRFm.js";import{m as te}from"./proxy-BMX__oQJ.js";function se(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}var f,y,c,p,g,k,P,F,re=(F=class extends H{constructor(e,r){super();v(this,g);v(this,f);v(this,y);v(this,c);v(this,p);C(this,f,e),this.setOptions(r),this.bindMethods(),w(this,g,k).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var i;const r=this.options;this.options=n(this,f).defaultMutationOptions(e),W(this.options,r)||n(this,f).getMutationCache().notify({type:"observerOptionsUpdated",mutation:n(this,c),observer:this}),r!=null&&r.mutationKey&&this.options.mutationKey&&J(r.mutationKey)!==J(this.options.mutationKey)?this.reset():((i=n(this,c))==null?void 0:i.state.status)==="pending"&&n(this,c).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=n(this,c))==null||e.removeObserver(this)}onMutationUpdate(e){w(this,g,k).call(this),w(this,g,P).call(this,e)}getCurrentResult(){return n(this,y)}reset(){var e;(e=n(this,c))==null||e.removeObserver(this),C(this,c,void 0),w(this,g,k).call(this),w(this,g,P).call(this)}mutate(e,r){var i;return C(this,p,r),(i=n(this,c))==null||i.removeObserver(this),C(this,c,n(this,f).getMutationCache().build(n(this,f),this.options)),n(this,c).addObserver(this),n(this,c).execute(e)}},f=new WeakMap,y=new WeakMap,c=new WeakMap,p=new WeakMap,g=new WeakSet,k=function(){var r;const e=((r=n(this,c))==null?void 0:r.state)??se();C(this,y,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},P=function(e){q.batch(()=>{var r,i,o,d,u,h,m,S;if(n(this,p)&&this.hasListeners()){const x=n(this,y).variables,j=n(this,y).context;(e==null?void 0:e.type)==="success"?((i=(r=n(this,p)).onSuccess)==null||i.call(r,e.data,x,j),(d=(o=n(this,p)).onSettled)==null||d.call(o,e.data,null,x,j)):(e==null?void 0:e.type)==="error"&&((h=(u=n(this,p)).onError)==null||h.call(u,e.error,x,j),(S=(m=n(this,p)).onSettled)==null||S.call(m,void 0,e.error,x,j))}this.listeners.forEach(x=>{x(n(this,y))})})},F);function L(t,e){const r=K(e),[i]=b.useState(()=>new re(r,t));b.useEffect(()=>{i.setOptions(t)},[i,t]);const o=b.useSyncExternalStore(b.useCallback(u=>i.subscribe(q.batchCalls(u)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),d=b.useCallback((u,h)=>{i.mutate(u,h).catch(B)},[i]);if(o.error&&ee(i.options.throwOnError,[o.error]))throw o.error;return{...o,mutate:d,mutateAsync:o.mutate}}const ie="https://zfmlzxhxhaezdkzjanbc.supabase.co",ae="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbWx6eGh4aGFlemRremphbmJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NDc4MzIsImV4cCI6MjA2NjMyMzgzMn0.x6GpX8ep6YxVEZQt7pcH0SIWzxhTYcXLnaVmD5IGErw",I=Y(ie,ae),ne=V(t=>({userId:null,setUserId:e=>t({userId:e})}));async function oe({page:t,pageSize:e,searchTerm:r,filterType:i}){let o=I.from("challenges").select("*",{count:"exact"}).order("start_date",{ascending:!0}).eq("is_active",!0);r!=null&&r.trim()&&(o=o.ilike("title",`%${r.trim()}%`)),i&&i.length>0&&(o=o.in("challenge_type",i)),o=o.range(t*e,t*e+e-1);const{data:d,error:u,count:h}=await o;if(u)throw u;return{challenges:d??[],count:h}}function le(t){var r;const e=["challenges",t.page,t.pageSize,t.searchTerm,(r=t.filterType)==null?void 0:r.join(",")];return G(e,()=>oe(t))}async function ce(t){const{data:e,error:r}=await I.from("challenge_participants").select("*").eq("user_id",t);if(r)throw r;return e??[]}function ue(t){return G(["user_participants",t],()=>t?ce(t):Promise.resolve([]))}async function de(t,e){const{error:r}=await I.from("challenge_participants").upsert({user_id:t,challenge_id:e,progress:0,completed:!1},{onConflict:["user_id","challenge_id"]});if(r)throw r}async function he(t,e){const{error:r}=await I.from("challenge_participants").delete().eq("user_id",t).eq("challenge_id",e);if(r)throw r}const O=10,ve=()=>{const t=ne(s=>s.userId),[e,r]=b.useState(""),[i,o]=b.useState(0),[d,u]=b.useState([]),h=K(),{data:m,isLoading:S,isError:x}=le({page:i,pageSize:O,searchTerm:e,filterType:d}),j=(m==null?void 0:m.challenges)??[],Q=(m==null?void 0:m.count)??0,E=Math.ceil(Q/O),{data:N}=ue(t),U=L(s=>t?de(t,s):Promise.reject("User not logged in"),{onSuccess:()=>{_.success("Inscription au défi réussie"),h.invalidateQueries(["user_participants",t])},onError:s=>_.error(`Erreur inscription : ${s.message||s}`)}),z=L(s=>t?he(t,s):Promise.reject("User not logged in"),{onSuccess:()=>{_.success("Désinscription du défi réussie"),h.invalidateQueries(["user_participants",t])},onError:s=>_.error(`Erreur désinscription : ${s.message||s}`)}),R=b.useCallback(s=>(N==null?void 0:N.some(l=>l.challenge_id===s))??!1,[N]),T=s=>{R(s)?z.mutate(s):U.mutate(s)},$=["daily","weekly","monthly","competition","custom"],X=s=>{u(l=>l.includes(s)?l.filter(Z=>Z!==s):[...l,s]),o(0)};return a.jsxs("main",{className:"min-h-screen p-6 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 max-w-6xl mx-auto",children:[a.jsx("h1",{className:"text-3xl font-extrabold mb-6 text-center",children:"Défis MyFitHero"}),a.jsx("div",{className:"max-w-md mx-auto mb-6",children:a.jsx("input",{type:"text",value:e,onChange:s=>{r(s.target.value),o(0)},placeholder:"Rechercher un défi...",className:"w-full p-2 border rounded-md dark:bg-gray-800 dark:border-gray-600","aria-label":"Rechercher un défi"})}),a.jsx("fieldset",{className:"flex flex-wrap justify-center gap-3 mb-6","aria-label":"Filtres types de défis",children:$.map(s=>{const l=d.includes(s);return a.jsxs("label",{className:A("cursor-pointer select-none rounded px-3 py-1 border",l?"bg-blue-600 text-white border-blue-600":"border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300"),children:[a.jsx("input",{type:"checkbox",checked:l,onChange:()=>X(s),className:"sr-only"}),s.charAt(0).toUpperCase()+s.slice(1)]},s)})}),a.jsxs("div",{className:"grid gap-6 md:grid-cols-2",children:[S&&Array.from({length:O}).map((s,l)=>a.jsx("div",{className:"p-6 border rounded-md bg-gray-200 dark:bg-gray-700 animate-pulse h-48"},l)),x&&a.jsx("div",{className:"col-span-full text-center text-red-600",children:"Erreur de chargement des défis."}),!S&&j.length===0&&a.jsx("div",{className:"text-center text-gray-600",children:"Aucun défi trouvé."}),j.map(s=>{const l=R(s.id);return a.jsxs(te.article,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"p-6 border rounded-lg bg-white dark:bg-gray-800 shadow flex flex-col","aria-live":"polite","aria-label":`Défi ${s.title}`,children:[a.jsx("h2",{className:"text-xl font-semibold mb-2",children:s.title}),a.jsx("p",{className:"flex-grow text-gray-700 dark:text-gray-300 mb-4 line-clamp-4",children:s.description}),a.jsxs("div",{className:"mb-4 text-sm",children:[a.jsxs("span",{children:[a.jsx("strong",{children:"Type :"})," ",s.challenge_type]}),a.jsx("br",{}),a.jsxs("span",{children:[a.jsx("strong",{children:"Objectif :"})," ",s.goal_type," - ",s.goal_target]}),a.jsx("br",{}),a.jsxs("span",{children:["Période : ",new Date(s.start_date).toLocaleDateString()," -"," ",new Date(s.end_date).toLocaleDateString()]})]}),a.jsx("button",{onClick:()=>T(s.id),disabled:U.isLoading||z.isLoading,className:A("px-4 py-2 rounded-md font-semibold",l?"bg-red-600 hover:bg-red-700 text-white":"bg-green-600 hover:bg-green-700 text-white"),"aria-pressed":l,"aria-label":l?`Se désinscrire du défi ${s.title}`:`S'inscrire au défi ${s.title}`,children:l?"Se désinscrire":"S'inscrire"})]},s.id)})]}),a.jsxs("nav",{className:"flex justify-center items-center mt-8 space-x-4","aria-label":"Pagination des défis",children:[a.jsx("button",{onClick:()=>o(s=>Math.max(s-1,0)),disabled:i===0,className:"px-4 py-2 rounded bg-blue-600 text-white disabled:opacity-50","aria-label":"Page précédente",children:"Précédent"}),a.jsxs("span",{"aria-live":"polite","aria-atomic":"true",className:"text-lg",children:["Page ",i+1," / ",E]}),a.jsx("button",{onClick:()=>o(s=>s+1<E?s+1:s),disabled:i+1>=E,className:"px-4 py-2 rounded bg-blue-600 text-white disabled:opacity-50","aria-label":"Page suivante",children:"Suivant"})]})]})};export{ve as default};
//# sourceMappingURL=ChallengesPage-BliySRFP.js.map
